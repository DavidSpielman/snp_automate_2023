<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4">
  <BehaviorTree ID="main">
    <ForceSuccess>
      <ReactiveSequence>
        <RosSpinner/>
        <ButtonMonitor name="Reset"
                       button="reset"
                       _description="Sequence has been reset to start state"/>
        <KeepRunningUntilFailure>
          <ForceSuccess>
            <ReactiveSequence>
              <ButtonMonitor name="Halt"
                             button="halt"
                             _description="Current task has been halted"/>
              <SubTree ID="process"
                       _autoremap="true"/>
            </ReactiveSequence>
          </ForceSuccess>
        </KeepRunningUntilFailure>
      </ReactiveSequence>
    </ForceSuccess>
  </BehaviorTree>

  <BehaviorTree ID="motion">
    <Sequence>
      <StartPointQueueMode name="Enable Robot"
                           service_name="start_point_queue_mode"/>
      <UpdateTrajectoryStartState name="Update Trajectory Start State"
                                  input="{approach}"
                                  topic_name="/joint_states"
                                  output="{updated_approach}"/>
      <FollowJointTrajectoryAction name="Execute Approach Motion"
                                   action_name="{follow_joint_trajectory_action}"
                                   trajectory="{updated_approach}"/>
      <FollowJointTrajectoryAction name="Execute Process Motion"
                                   action_name="{follow_joint_trajectory_action}"
                                   trajectory="{process}"/>
      <FollowJointTrajectoryAction name="Execute Departure Motion"
                                   action_name="{follow_joint_trajectory_action}"
                                   trajectory="{departure}"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="process">
    <SNPSequenceWithMemory>
      <Progress end="20"
                start="0">
        <Sequence>
          <SetPage index="0">
            <ButtonApproval name="Approve Scan Motion Plan Creation"
                            approve_button="scan"
                            disapprove_button="back"
                            _description="Press next to generate a motion plan for part scanning"/>
          </SetPage>
          <GenerateScanMotionPlanService name="Generate Scan Motion Plan"
                                         service_name="generate_scan_motion_plan"
                                         approach="{scan_approach}"
                                         departure="{scan_departure}"
                                         process="{scan_process}"/>
          <CombineTrajectories first="{scan_approach}"
                               second="{scan_process}"
                               output="{scan_trajectory}"/>
          <CombineTrajectories first="{scan_trajectory}"
                               second="{scan_departure}"
                               output="{scan_trajectory}"/>
          <MotionPlanPub name="Publish Scan Motion Plan"
                         topic_name="motion_plan"
                         trajectory="{scan_trajectory}"/>
        </Sequence>
      </Progress>
      <Progress end="40"
                start="20">
        <Sequence>
          <SetPage index="3">
            <ButtonApproval name="Approve Scan Execution"
                            approve_button="execute"
                            disapprove_button="back"
                            _description="Press next to approve the scan motion plan and proceed to scan motion execution"/>
          </SetPage>
          <SubTree ID="scan"
                   approach="{scan_approach}"
                   departure="{scan_departure}"
                   process="{scan_process}"
                   _autoremap="true"/>
        </Sequence>
      </Progress>
      <Progress end="60"
                start="40">
        <Sequence>
          <SetPage index="1">
            <ButtonApproval name="Approve Tool Path Plan"
                            approve_button="tpp"
                            disapprove_button="back"
                            _description="Press next to create a tool path plan"/>
          </SetPage>
          <GenerateToolPathsService name="Generate Tool Paths"
                                    service_name="generate_tool_paths"
                                    tool_paths="{tool_paths}"/>
          <ToolPathsPub name="Publish Tool Paths"
                        tool_paths="{tool_paths}"
                        topic_name="tool_paths"/>
        </Sequence>
      </Progress>
      <Progress end="80"
                start="60">
        <Sequence>
          <SetPage index="1">
            <ButtonApproval name="Approve Motion Plan Generation"
                            approve_button="plan"
                            disapprove_button="back"
                            _description="Press next to generate a motion plan for the tool path"/>
          </SetPage>
          <GenerateMotionPlanService name="Generate Process Motion Plan"
                                     service_name="generate_motion_plan"
                                     tool_paths="{tool_paths}"
                                     approach="{approach}"
                                     departure="{departure}"
                                     process="{process}"/>
          <CombineTrajectories first="{approach}"
                               second="{process}"
                               output="{trajectory}"/>
          <CombineTrajectories first="{trajectory}"
                               second="{departure}"
                               output="{trajectory}"/>
          <MotionPlanPub name="Publish Process Motion Plan"
                         topic_name="motion_plan"
                         trajectory="{trajectory}"/>
        </Sequence>
      </Progress>
      <Progress end="100"
                start="80">
        <Sequence>
          <SetPage index="3">
            <ButtonApproval name="Approve Process Motion Execution"
                            approve_button="execute"
                            disapprove_button="back"
                            _description="Press next to approve the process motion plan and proceed to process motion execution"/>
          </SetPage>
          <SubTree ID="motion"
                   approach="{approach}"
                   departure="{departure}"
                   process="{process}"
                   trajectory="{motion_plan}"
                   _autoremap="true"/>
        </Sequence>
      </Progress>
      <SetPage index="4">
        <ButtonApproval name="Approve Restart"
                        approve_button=""
                        disapprove_button="back"/>
      </SetPage>
    </SNPSequenceWithMemory>
  </BehaviorTree>

  <BehaviorTree ID="scan">
    <Sequence>
      <UpdateTrajectoryStartState name="Update Trajectory Start State"
                                  input="{approach}"
                                  topic_name="/joint_states"
                                  output="{updated_approach}"/>
      <StartPointQueueMode name="Enable Robot"
                           service_name="start_point_queue_mode"/>
      <FollowJointTrajectoryAction name="Execute Scan Approach Motion"
                                   action_name="{follow_joint_trajectory_action}"
                                   trajectory="{updated_approach}"/>
      <StartReconstructionService name="Start Reconstruction"
                                  service_name="start_reconstruction"/>
      <FollowJointTrajectoryAction name="Execute Scan Motion"
                                   action_name="{follow_joint_trajectory_action}"
                                   trajectory="{process}"/>
      <StopReconstructionService name="Stop Reconstruction"
                                 service_name="stop_reconstruction"/>
      <FollowJointTrajectoryAction name="Execute Scan Departure Motion"
                                   action_name="{follow_joint_trajectory_action}"
                                   trajectory="{departure}"/>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="ButtonApproval"
            editable="true">
      <input_port name="approve_button"/>
      <input_port name="disapprove_button"/>
    </Action>
    <Condition ID="ButtonMonitor"
               editable="true">
      <input_port name="button"/>
    </Condition>
    <Action ID="CombineTrajectories"
            editable="true">
      <input_port name="first"/>
      <input_port name="second"/>
      <output_port name="output"/>
    </Action>
    <Action ID="FollowJointTrajectoryAction"
            editable="true">
      <input_port name="action_name"
                  default="follow_joint_trajectory"/>
      <input_port name="trajectory"
                  default="{trajectory}"/>
    </Action>
    <Action ID="GenerateMotionPlanService"
            editable="true">
      <input_port name="service_name"
                  default="generate_motion_plan"/>
      <input_port name="tool_paths"
                  default="{tool_paths}"/>
      <output_port name="approach"
                   default="{approach}"/>
      <output_port name="departure"
                   default="{departure}"/>
      <output_port name="process"
                   default="{process}"/>
    </Action>
    <Action ID="GenerateScanMotionPlanService"
            editable="true">
      <input_port name="service_name"
                  default="generate_scan_motion_plan"/>
      <output_port name="approach"
                   default="{scan_approach}"/>
      <output_port name="departure"
                   default="{scan_departure}"/>
      <output_port name="process"
                   default="{scan_process}"/>
    </Action>
    <Action ID="GenerateToolPathsService"
            editable="true">
      <input_port name="service_name"
                  default="generate_tool_paths"/>
      <input_port name="tool_paths"
                  default="{tool_paths}"/>
    </Action>
    <Action ID="MotionPlanPub"
            editable="true">
      <input_port name="topic_name"/>
      <input_port name="trajectory"/>
    </Action>
    <Decorator ID="Progress"
               editable="true">
      <input_port name="end"
                  default="100"/>
      <input_port name="start"
                  default="0"/>
    </Decorator>
    <Condition ID="RosSpinner"
               editable="true"/>
    <Control ID="SNPSequenceWithMemory"
             editable="true"/>
    <Decorator ID="SetPage"
               editable="true">
      <input_port name="index"
                  default="0"/>
    </Decorator>
    <Action ID="StartPointQueueMode"
            editable="true">
      <input_port name="service_name"
                  default="start_point_queue_mode"/>
    </Action>
    <Action ID="StartReconstructionService"
            editable="true">
      <input_port name="service_name"
                  default="start_reconstruction"/>
    </Action>
    <Action ID="StopReconstructionService"
            editable="true">
      <input_port name="service_name"
                  default="stop_reconstruction"/>
    </Action>
    <Action ID="ToolPathsPub"
            editable="true">
      <input_port name="tool_paths"
                  default="{tool_paths}"/>
      <input_port name="topic_name"
                  default="tool_paths"/>
    </Action>
    <Action ID="UpdateTrajectoryStartState"
            editable="true">
      <input_port name="input"
                  default="{trajectory}"/>
      <input_port name="topic_name"
                  default="/joint_states"/>
      <output_port name="output"
                   default="{trajectory}"/>
    </Action>
  </TreeNodesModel>

</root>
